# NFC Tag -> Spoolman Integration
# Copy this file to extended/klipper/ to enable automatic spool tracking
#
# When an NFC tag with a spool_id field is read, this macro is called
# with the channel (0-3 = T0-T3) and the spool_id from the tag.
#
# Tag format example:
# {"protocol":"openspool","version":"1.0","type":"PLA","brand":"Elegoo","color_hex":"#FF5733","spool_id":42}
#
# Customize this macro to integrate with your Spoolman setup.

[gcode_macro ON_NFC_SPOOL_READ]
description: Called automatically when NFC tag with spool_id is read
gcode:
    {% set channel = params.CHANNEL|int %}
    {% set spool_id = params.SPOOL_ID|int %}
    {% set tool = "T" ~ channel %}

    # Update tool's spool assignment (requires tool macros with spool_id variable)
    SET_GCODE_VARIABLE MACRO={tool} VARIABLE=spool_id VALUE={spool_id}

    # Optional: Trigger deferred spool save to Moonraker/Spoolman
    # UPDATE_DELAYED_GCODE ID=SAVE_SELECTED_SPOOLS DURATION=1

    RESPOND PREFIX="NFC" MSG="Spool {spool_id} assigned to {tool}"
