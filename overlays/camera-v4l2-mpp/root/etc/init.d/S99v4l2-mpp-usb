#!/bin/sh

[ ! -e /oem/.camera-native ] || exit 0

CMD_CAPTURE=/usr/local/bin/capture-usb-mpp
CMD_CAPTURE_ARGS="--device /dev/video18 --jpeg-sock /tmp/capture-usb-jpeg.sock --mjpeg-sock /tmp/capture-usb-mjpeg.sock --h264-sock /tmp/capture-usb-h264.sock"

CMD_WEBRTC=/usr/local/bin/stream-webrtc
CMD_WEBRTC_ARGS="--h264-sock /tmp/capture-usb-h264.sock --webrtc-sock /tmp/capture-usb-webrtc.sock"

CMD_HTTP=/usr/local/bin/stream-http.py
CMD_HTTP_ARGS="--jpeg-sock /tmp/capture-usb-jpeg.sock --mjpeg-sock /tmp/capture-usb-mjpeg.sock --h264-sock /tmp/capture-usb-h264.sock --webrtc-sock /tmp/capture-usb-webrtc.sock --bind 127.0.0.1 --port 8081"

CAPTURE_PID=/var/run/capture-usb-mpp.pid
MONITOR_PID=/var/run/capture-usb-mpp-monitor.pid

start_capture() {
    printf "Starting capture-usb-mpp: "
    start-stop-daemon -S -b -q -m -p "$CAPTURE_PID" -x $CMD_CAPTURE -- $CMD_CAPTURE_ARGS
    echo "OK"
}

start_monitor() {
    if pid_mon="$(cat "$MONITOR_PID" 2>/dev/null)" && kill -0 "$pid_mon" 2>/dev/null; then
        return
    fi

    (
        while true; do
            if ! pid="$(cat "$CAPTURE_PID" 2>/dev/null)" || ! kill -0 "$pid" 2>/dev/null; then
                echo "capture-usb-mpp not running, restarting..."
                start_capture
            fi
            sleep 5
        done
    ) &
    echo $! > "$MONITOR_PID"
}

stop_monitor() {
    if [ -f "$MONITOR_PID" ]; then
        kill "$(cat "$MONITOR_PID")" 2>/dev/null
        rm -f "$MONITOR_PID"
    fi
}

start() {
    if [ ! -e /dev/video18 ]; then
        echo "USB camera device /dev/video18 not found, not starting."
        return
    fi

    start_capture
    start_monitor

    printf "Starting stream-webrtc: "
    start-stop-daemon -S -b -q -m -p /var/run/stream-usb-webrtc.pid -c lava -x $CMD_WEBRTC -- $CMD_WEBRTC_ARGS
    echo "OK"

    printf "Starting stream-http: "
    start-stop-daemon -S -b -q -m -p /var/run/stream-usb-http.pid -c lava -x /usr/bin/python3 -- $CMD_HTTP $CMD_HTTP_ARGS
    echo "OK"
}

stop() {
    stop_monitor

    printf "Stopping stream-http: "
    start-stop-daemon -K -q -p /var/run/stream-usb-http.pid
    echo "OK"

    printf "Stopping stream-webrtc: "
    start-stop-daemon -K -q -p /var/run/stream-usb-webrtc.pid
    echo "OK"

    printf "Stopping capture-usb-mpp: "
    start-stop-daemon -K -q -p "$CAPTURE_PID"
    echo "OK"
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        stop
        sleep 1
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
